{% extends "users/base.html" %}
{% load humanize %}
{% load i18n %}

{% block title %}{% trans "My Profile" %}{% endblock %}

{% block main_content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/">
                        <i class="bi bi-house"></i> {% trans "Home" %}
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'users:profile' %}">{% trans "User Management" %}</a>
                </li>
                <li class="breadcrumb-item active">{% trans "My Profile" %}</li>
            </ol>
        </nav>
        <h1 class="nrc-heading mb-0">
            <i class="bi bi-person-circle me-2 text-success"></i>{% trans "My Profile" %}
        </h1>
    </div>
    <div class="btn-group" role="group">
        <a href="{% url 'users:profile_edit' %}" class="btn btn-primary">
            <i class="bi bi-pencil me-1"></i>{% trans "Edit Profile" %}
        </a>
        <a href="{% url 'users:change_password' %}" class="btn btn-outline-secondary">
            <i class="bi bi-key me-1"></i>{% trans "Change Password" %}
        </a>
    </div>
</div>

<!-- Profile Information -->
<div class="row">
    <div class="col-lg-8">
        <!-- User Info Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person me-2"></i>{% trans "User Information" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">{% trans "Username" %}:</dt>
                            <dd class="col-sm-8">{{ user.username }}</dd>
                            <dt class="col-sm-4">{% trans "Email" %}:</dt>
                            <dd class="col-sm-8">
                                {{ user.email }}
                                {% if profile.email_verified %}
                                    <span class="badge bg-success ms-2">
                                        <i class="bi bi-check-circle me-1"></i>{% trans "Verified" %}
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning ms-2">
                                        <i class="bi bi-exclamation-circle me-1"></i>{% trans "Not Verified" %}
                                    </span>
                                {% endif %}
                            </dd>
                            <dt class="col-sm-4">{% trans "Full Name" %}:</dt>
                            <dd class="col-sm-8">
                                {% if user.first_name or user.last_name %}
                                    {{ user.first_name }} {{ user.last_name }}
                                {% else %}
                                    <em class="text-muted">{% trans "Not provided" %}</em>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">{% trans "Language" %}:</dt>
                            <dd class="col-sm-7">{{ profile.get_preferred_language_display }}</dd>
                            <dt class="col-sm-5">{% trans "Timezone" %}:</dt>
                            <dd class="col-sm-7">{{ profile.get_timezone_display }}</dd>
                            <dt class="col-sm-5">{% trans "Member Since" %}:</dt>
                            <dd class="col-sm-7">{{ user.date_joined|date:"M d, Y" }}</dd>
                        </dl>
                    </div>
                </div>

                {% if not profile.email_verified %}
                <div class="alert alert-warning mt-3" role="alert">
                    <h6 class="alert-heading">{% trans "Email Verification Required" %}</h6>
                    <p class="mb-2">{% trans "Please verify your email address to enable email notifications." %}</p>
                    <form method="post" action="{% url 'users:request_email_verification' %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-warning">
                            <i class="bi bi-envelope me-1"></i>{% trans "Send Verification Email" %}
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Notification Settings Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bell me-2"></i>{% trans "Notification Settings" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications"
                                   {% if profile.email_notifications_enabled %}checked{% endif %}
                                   {% if not profile.email_verified %}disabled{% endif %}>
                            <label class="form-check-label" for="emailNotifications">
                                {% trans "Email Notifications" %}
                                {% if not profile.email_verified %}
                                    <small class="text-muted">({% trans "requires email verification" %})</small>
                                {% endif %}
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <a href="{% url 'users:notification_preferences' %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-gear me-1"></i>{% trans "Advanced Settings" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Statistics Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-graph-up me-2"></i>{% trans "Activity Summary" %}
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h4 class="text-primary">{{ subscriptions.count }}</h4>
                    <small class="text-muted">{% trans "Active Subscriptions" %}</small>
                </div>
                <div class="text-center mb-3">
                    <h4 class="text-info">{{ notification_stats.total|intcomma }}</h4>
                    <small class="text-muted">{% trans "Total Notifications" %}</small>
                </div>
                <div class="text-center">
                    <h4 class="text-warning">{{ notification_stats.unread|intcomma }}</h4>
                    <small class="text-muted">{% trans "Unread Notifications" %}</small>
                </div>
            </div>
        </div>

        <!-- Subscriptions Card -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-bookmark me-2"></i>{% trans "Alert Subscriptions" %}
                </h6>
            </div>
            <div class="card-body">
                {% if subscriptions %}
                    {% for subscription in subscriptions %}
                    <div class="mb-2 p-2 border rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <small class="text-muted">{{ subscription.get_frequency_display }}</small>
                                <div class="small">
                                    <strong>{% trans "Locations" %}:</strong>
                                    {% for location in subscription.locations.all %}
                                        <span class="badge bg-light text-dark">{{ location.name }}</span>
                                    {% empty %}
                                        <em>{% trans "All locations" %}</em>
                                    {% endfor %}
                                </div>
                                <div class="small">
                                    <strong>{% trans "Shock Types" %}:</strong>
                                    {% for shock_type in subscription.shock_types.all %}
                                        <span class="badge bg-light text-dark">{{ shock_type.name }}</span>
                                    {% empty %}
                                        <em>{% trans "All types" %}</em>
                                    {% endfor %}
                                </div>
                            </div>
                            <span class="badge {% if subscription.active %}bg-success{% else %}bg-secondary{% endif %}">
                                {% if subscription.active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="text-center mt-3">
                        <a href="/alerts/subscriptions/" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-gear me-1"></i>{% trans "Manage Subscriptions" %}
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted text-center">{% trans "No active subscriptions" %}</p>
                    <div class="text-center">
                        <a href="/alerts/subscriptions/create/" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus me-1"></i>{% trans "Create Subscription" %}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const emailToggle = document.getElementById('emailNotifications');
    if (emailToggle && !emailToggle.disabled) {
        emailToggle.addEventListener('change', function() {
            fetch('{% url "users:api_toggle_email_notifications" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show a toast or update UI
                    console.log(data.message);
                } else {
                    // Revert toggle on error
                    emailToggle.checked = !emailToggle.checked;
                    alert('{% trans "Error updating notification settings" %}');
                }
            })
            .catch(error => {
                emailToggle.checked = !emailToggle.checked;
                alert('{% trans "Error updating notification settings" %}');
            });
        });
    }
});
</script>
{% endblock %}