{% extends "alerts/base.html" %}
{% load i18n %}
{% load humanize %}
{% load translation_tags %}

{% block title %}{{ alert.title }} - {% trans "Alerts" %} - NRC EWAS{% endblock %}

{% block main_content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/">
                        <i class="bi bi-house"></i> {% translate "Home" %}
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'alerts:alert_list' %}">{% translate "Alert System" %}</a>
                </li>
                <li class="breadcrumb-item active">{{ alert.title|truncatechars:50 }}</li>
            </ol>
        </nav>
        <h1 class="nrc-heading mb-0">
            <i class="bi bi-exclamation-triangle me-2 text-danger"></i>{% translate "Alert Details" %}
        </h1>
    </div>
    <div class="btn-group" role="group">
        <a href="{% url 'alerts:alert_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>{% translate "Back to List" %}
        </a>
        <a href="{% url 'alerts:alert_map' %}" class="btn btn-outline-primary">
            <i class="bi bi-map me-1"></i>View on Map
        </a>
    </div>
</div>

<div class="row">
    <!-- Main Alert Content -->
    <div class="col-lg-8">
        <!-- Alert Header -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="h3 mb-2">{{ alert.title }}</h1>
                        <div class="d-flex align-items-center gap-3 text-muted">
                            <span class="badge {{ alert.shock_type.background_css_class }} text-white fs-6">
                                {{ alert.shock_type.name }}
                            </span>
                            <span class="badge severity-{{ alert.severity }} fs-6">
                                {% trans "Severity" %} {{ alert.severity }} - {{ alert.severity_display }}
                            </span>
                            <span>
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ alert.shock_date|date:"F d, Y" }}
                            </span>
                        </div>
                    </div>

                    <!-- Alert Status -->
                    <div class="text-end">
                        {% if alert.is_active %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i>
                                {% trans "Active" %}
                            </span>
                        {% else %}
                            <span class="badge bg-secondary">
                                <i class="bi bi-clock me-1"></i>
                                {% trans "Expired" %}
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card-body">
                <!-- Alert Content -->
                <div class="alert-content">
                    {{ alert.text|linebreaks }}
                </div>

                <!-- Alert Metadata -->
                <div class="row mt-4 pt-3 border-top">
                    <div class="col-md-6">
                        <h6>{% trans "Data Source" %}</h6>
                        <p class="mb-2">
                            <i class="bi bi-database me-1"></i>
                            {{ alert.data_source.name }}
                        </p>
                        {% if alert.data_source.info_url %}
                        <p>
                            <a href="{{ alert.data_source.info_url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                <i class="bi bi-link-45deg me-1"></i>
                                {% trans "Source Info" %}
                            </a>
                        </p>
                        {% endif %}

                        {% if alert.detector_name %}
                        <div class="mt-3">
                            <h6>{% trans "Detection Method" %}</h6>
                            <p class="mb-1">
                                <i class="bi bi-cpu me-1"></i>
                                {{ alert.detector_name }}
                            </p>
                            {% if alert.source_detection %}
                            <small class="text-muted d-block">
                                <i class="bi bi-graph-up me-1"></i>
                                {% trans "Confidence" %}: {{ alert.source_detection.confidence_score|floatformat:3 }}
                            </small>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>{% trans "Validity Period" %}</h6>
                        <p>
                            <i class="bi bi-clock me-1"></i>
                            <strong>{% trans "Valid from" %}:</strong> {{ alert.valid_from|date:"F d, Y H:i" }} <strong>{% trans "to" %}</strong> {{ alert.valid_until|date:"F d, Y H:i" }}
                        </p>
                    </div>
                </div>

                <!-- Affected Locations -->
                <div class="mt-3">
                    <h6>{% trans "Affected Areas" %}</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% if alert.locations.all %}
                            {% for location in alert.locations.all %}
                            <span class="badge bg-primary text-white">
                                <i class="bi bi-geo-alt me-1"></i>
                                {{ location.name }}
                            </span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">{% translate "No locations specified" %}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- {% translate "Community Comments" %} -->
        {% with all_comments=alert.get_all_comments %}
        {% if all_comments %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-chat-dots me-2"></i>
                    {% trans "Community Feedback" %} ({{ all_comments.count }})
                </h5>
            </div>
            <div class="card-body">
                {% for user_alert in all_comments %}
                <div class="border-start border-primary border-3 ps-3 mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <small class="text-muted">
                            <strong>{{ user_alert.user.username }}</strong>
                            {% if user_alert.user.get_full_name %}({{ user_alert.user.get_full_name }}){% endif %}
                        </small>
                        <small class="text-muted">{{ user_alert.created_at|timesince }} {% trans "ago" %}</small>
                    </div>
                    <p class="mb-2">{{ user_alert.comment }}</p>
                    {% if user_alert.rating %}
                    <div class="d-flex align-items-center">
                        <small class="text-muted me-2">{% trans "Rating" %}:</small>
                        {% for i in "12345" %}
                        <i class="bi bi-star{% if i|add:0 <= user_alert.rating %}-fill text-warning{% endif %} me-1" style="font-size: 0.75rem;"></i>
                        {% endfor %}
                        <small class="text-muted ms-1">{{ user_alert.rating }}/5</small>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endwith %}

        <!-- Source Data Point -->
        {% include 'includes/data_point_detail.html' %}
    </div>

    <!-- Sidebar - User Interactions -->
    <div class="col-lg-4">
        <!-- User Actions Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person-check me-2"></i>
                    {% trans "Your Actions" %}
                </h5>
            </div>
            <div class="card-body">
                <!-- {% translate "Bookmark Button" %} -->
                <div class="d-grid gap-2 mb-3">
                    {% if user_alert and user_alert.bookmarked %}
                    <button type="button" class="btn btn-warning bookmark-btn" data-alert-id="{{ alert.id }}">
                        <i class="bi bi-bookmark-fill me-1"></i>
                        {% trans "Remove Bookmark" %}
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-outline-warning bookmark-btn" data-alert-id="{{ alert.id }}">
                        <i class="bi bi-bookmark me-1"></i>
                        {% trans "Add Bookmark" %}
                    </button>
                    {% endif %}
                </div>

                <!-- Community Rating Section -->
                <div class="mb-3">
                    <label class="form-label">{% trans "Community Rating" %}</label>
                    {% if alert.average_rating %}
                    <div class="mb-2">
                        <div class="d-flex align-items-center">
                            {% for i in "12345" %}
                            <i class="bi bi-star{% if i|add:0 <= alert.average_rating %}-fill text-warning{% endif %} me-1"></i>
                            {% endfor %}
                            <span class="ms-2">
                                <strong>{{ alert.average_rating|floatformat:1 }}/5</strong>
                                <small class="text-muted">({{ alert.rating_count }} rating{{ alert.rating_count|pluralize }})</small>
                            </span>
                        </div>
                    </div>
                    {% else %}
                    <div class="mb-2 text-muted">{% translate "No ratings yet" %}</div>
                    {% endif %}

                    <!-- Your Rating -->
                    <div class="mt-2">
                        <small class="form-label">{% trans "Your Rating" %}</small>
                        <div class="star-rating" data-alert-id="{{ alert.id }}">
                            {% for i in "12345" %}
                            <button type="button" class="btn btn-sm star-btn" data-rating="{{ i }}">
                                <i class="bi bi-star{% if user_alert and user_alert.rating and i|add:0 <= user_alert.rating %}-fill text-warning{% endif %}"></i>
                            </button>
                            {% endfor %}
                        </div>
                        {% if user_alert and user_alert.rating %}
                        <small class="text-muted">
                            {% translate "You rated this" %}: {{ user_alert.rating }}/5
                            {% if user_alert.rating_at %}({{ user_alert.rating_at|timesince }} {% trans "ago" %}){% endif %}
                        </small>
                        {% endif %}
                    </div>
                </div>

                <!-- Community Flags -->
                {% if alert.is_flagged_false or alert.is_flagged_incomplete %}
                <div class="mb-3">
                    <label class="form-label">{% trans "Community Flags" %}</label>
                    <div class="d-flex gap-2 mb-2">
                        {% if alert.is_flagged_false %}
                        <div class="badge bg-danger text-white">
                            <i class="bi bi-x-circle me-1"></i>
                            {% trans "Disputed" %} ({{ alert.false_flag_count }})
                        </div>
                        {% endif %}
                        {% if alert.is_flagged_incomplete %}
                        <div class="badge bg-warning text-dark">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            {% trans "Incomplete" %} ({{ alert.incomplete_flag_count }})
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Flag Buttons -->
                <div class="mb-3">
                    <label class="form-label">{% trans "Flag Issues" %}</label>
                    <div class="d-grid gap-1">
                        <button type="button" class="btn btn-sm flag-btn
                                {% if user_alert and user_alert.flag_false %}btn-danger{% else %}btn-outline-danger{% endif %}"
                                data-alert-id="{{ alert.id }}" data-flag-type="false">
                            <i class="bi bi-x-circle me-1"></i>
                            {% trans "Flag as False" %}
                        </button>
                        <button type="button" class="btn btn-sm flag-btn
                                {% if user_alert and user_alert.flag_incomplete %}btn-warning{% else %}btn-outline-warning{% endif %}"
                                data-alert-id="{{ alert.id }}" data-flag-type="incomplete">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            {% trans "Flag as Incomplete" %}
                        </button>
                    </div>
                </div>

                <!-- Feedback Form -->
                <div class="mb-3">
                    <label class="form-label">{% trans "Your Feedback" %}</label>
                    <form id="feedback-form" data-alert-id="{{ alert.id }}">
                        {% csrf_token %}
                        <div class="mb-2">
                            {{ feedback_form.comment }}
                            <div class="form-text">{{ feedback_form.comment.help_text }}</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-send me-1"></i>
                                {% trans "Submit Feedback" %}
                            </button>
                        </div>
                    </form>

                    <!-- Previous Feedback Display -->
                    <div id="previous-feedback" class="mt-2" {% if not user_alert or not user_alert.comment %}style="display: none;"{% endif %}>
                        <div class="p-2 bg-light rounded">
                            <small class="text-muted">{% trans "Your previous feedback" %}:</small>
                            <p id="feedback-text" class="mb-0 small">{% if user_alert and user_alert.comment %}{{ user_alert.comment }}{% endif %}</p>
                        </div>
                    </div>
                </div>

                <!-- Reading Status -->
                {% if user_alert %}
                <div class="text-muted small">
                    {% if user_alert.read_at %}
                    <p class="mb-1">
                        <i class="bi bi-check-circle text-success me-1"></i>
                        {% trans "Read" %} {{ user_alert.read_at|timesince }} {% trans "ago" %}
                    </p>
                    {% endif %}
                    {% if user_alert.received_at %}
                    <p class="mb-0">
                        <i class="bi bi-envelope me-1"></i>
                        {% trans "Received" %} {{ user_alert.received_at|timesince }} {% trans "ago" %}
                    </p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<!-- CSRF Token for AJAX -->
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

{% endblock %}

{% block extra_js %}
<!-- Dynamic shock type styles -->
{% include "alerts/shock_type_styles.html" %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.getElementById('csrf-token').value;

    // Helper function to get current saved rating from the star display
    function getCurrentRating(starsContainer) {
        const stars = starsContainer.querySelectorAll('.star-btn i');
        let currentRating = 0;
        stars.forEach((star, index) => {
            if (star.classList.contains('bi-star-fill') && star.classList.contains('text-warning')) {
                currentRating = index + 1;
            }
        });
        return currentRating;
    }

    // Helper function to update star display
    function updateStarDisplay(starsContainer, rating) {
        const stars = starsContainer.querySelectorAll('.star-btn i');
        stars.forEach((star, index) => {
            star.style.color = ''; // Remove any inline color
            if (index < rating) {
                star.classList.remove('bi-star');
                star.classList.add('bi-star-fill', 'text-warning');
            } else {
                star.classList.remove('bi-star-fill', 'text-warning');
                star.classList.add('bi-star');
            }
        });
    }

    // Bookmark Toggle
    document.querySelector('.bookmark-btn')?.addEventListener('click', function() {
        const alertId = this.dataset.alertId;
        const isBookmarked = this.classList.contains('btn-warning');

        fetch(`/alerts/alert/${alertId}/bookmark/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const icon = this.querySelector('i');
                if (data.bookmarked) {
                    this.classList.remove('btn-outline-warning');
                    this.classList.add('btn-warning');
                    icon.classList.remove('bi-bookmark');
                    icon.classList.add('bi-bookmark-fill');
                    this.innerHTML = '<i class="bi bi-bookmark-fill me-1"></i>{% trans "Remove Bookmark" %}';
                } else {
                    this.classList.remove('btn-warning');
                    this.classList.add('btn-outline-warning');
                    icon.classList.remove('bi-bookmark-fill');
                    icon.classList.add('bi-bookmark');
                    this.innerHTML = '<i class="bi bi-bookmark me-1"></i>{% trans "Add Bookmark" %}';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    // Star Rating
    document.querySelectorAll('.star-btn').forEach(button => {
        const starsContainer = button.closest('.star-rating');

        // Store the original rating when we first load
        if (!starsContainer.dataset.originalRating) {
            starsContainer.dataset.originalRating = getCurrentRating(starsContainer);
        }

        // Add hover effect to show rating preview
        button.addEventListener('mouseenter', function() {
            const hoverRating = parseInt(this.dataset.rating);
            // Show preview with hover styling
            updateStarDisplay(starsContainer, hoverRating);
            // Add hover color to make it clear this is a preview
            const stars = starsContainer.querySelectorAll('.star-btn i');
            stars.forEach((star, index) => {
                if (index < hoverRating) {
                    star.style.color = '#ffc107';
                }
            });
        });

        button.addEventListener('mouseleave', function() {
            // Restore the saved rating
            const savedRating = parseInt(starsContainer.dataset.originalRating) || 0;
            updateStarDisplay(starsContainer, savedRating);
        });

        button.addEventListener('click', function() {
            const alertId = this.closest('.star-rating').dataset.alertId;
            const rating = this.dataset.rating;

            console.log('Rating button clicked:', {alertId, rating, csrfToken: csrfToken ? 'present' : 'missing'});

            fetch(`/alerts/alert/${alertId}/rate/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'same-origin',
                body: `rating=${rating}`
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Rating response:', data);
                if (data.success) {
                    // Update star display and store new rating
                    const starsContainer = this.closest('.star-rating');
                    updateStarDisplay(starsContainer, data.rating);
                    starsContainer.dataset.originalRating = data.rating;
                } else {
                    console.error('Rating failed:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });

    // Flag Buttons
    document.querySelectorAll('.flag-btn').forEach(button => {
        button.addEventListener('click', function() {
            const alertId = this.dataset.alertId;
            const flagType = this.dataset.flagType;

            fetch(`/alerts/alert/${alertId}/flag/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'same-origin',
                body: `flag_type=${flagType}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.flagged) {
                        if (flagType === 'false') {
                            this.classList.remove('btn-outline-danger');
                            this.classList.add('btn-danger');
                        } else {
                            this.classList.remove('btn-outline-warning');
                            this.classList.add('btn-warning');
                        }
                    } else {
                        if (flagType === 'false') {
                            this.classList.remove('btn-danger');
                            this.classList.add('btn-outline-danger');
                        } else {
                            this.classList.remove('btn-warning');
                            this.classList.add('btn-outline-warning');
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });

    // Feedback Form
    document.getElementById('feedback-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const alertId = this.dataset.alertId;
        const formData = new FormData(this);
        const commentText = formData.get('comment');

        fetch(`/alerts/alert/${alertId}/feedback/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
            credentials: 'same-origin',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the previous feedback display immediately
                const feedbackDisplay = document.getElementById('previous-feedback');
                const feedbackText = document.getElementById('feedback-text');

                if (commentText && commentText.trim()) {
                    feedbackText.textContent = commentText.trim();
                    feedbackDisplay.style.display = 'block';
                } else {
                    feedbackDisplay.style.display = 'none';
                }

                // Reset the form
                this.reset();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});
</script>

<style>
.star-btn {
    border: none;
    background: none;
    padding: 2px;
}

.star-btn:hover i {
    color: #ffc107 !important;
}

.alert-content {
    font-size: 1.1em;
    line-height: 1.6;
}

.severity-1 { background-color: #d4edda; color: #155724; }
.severity-2 { background-color: #fff3cd; color: #856404; }
.severity-3 { background-color: #f8d7da; color: #721c24; }
.severity-4 { background-color: #f5c6cb; color: #721c24; }
.severity-5 { background-color: #dc3545; color: white; }

.badge.bg-conflict { background-color: #dc3545 !important; }
.badge.bg-natural { background-color: #fd7e14 !important; }
.badge.bg-health { background-color: #20c997 !important; }
.badge.bg-foodsec { background-color: #6f42c1 !important; }

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

</style>
{% endblock %}
