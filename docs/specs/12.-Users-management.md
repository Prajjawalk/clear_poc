## 12. User Management

The user management system provides authentication, authorization, and profile management capabilities for the EWAS platform. Through role-based access control and team organization features, the system ensures secure access to humanitarian data while maintaining operational flexibility and user accountability.

The framework extends Django's authentication system with domain-specific features including organizational profiles, geographical access controls, and detailed activity auditing necessary for humanitarian operations.

### 12.1 Key concepts

#### Authentication and registration
**User authentication** provides secure access to the EWAS platform through email-based login with enhanced security features. The registration process includes email verification, organizational affiliation validation, and role assignment based on operational requirements.

Authentication supports both standard password-based login and two-factor authentication (2FA) for enhanced security. Session management includes configurable timeouts, concurrent session limits, and automatic logout for security compliance.

Password policies enforce complexity requirements, expiration schedules, and breach detection to maintain account security. Account lockout mechanisms prevent brute force attacks while providing administrative override capabilities for operational continuity.

#### Role-based access control
**Role-based permissions** ensure users access only data and functionality appropriate to their operational responsibilities. The system implements hierarchical roles including administrators, alert managers, data analysts, field officers, and viewers, each with specific permission sets.

Permission inheritance allows role customization while maintaining security boundaries. Geographic access controls limit data visibility based on user location assignments, ensuring field officers access relevant regional information while maintaining global oversight capabilities for administrators.

Team-based permissions supplement individual roles, enabling collaborative access to shared resources while maintaining individual accountability through detailed audit trails.

#### User profiles and preferences
**Extended user profiles** capture organizational context, geographic assignments, and operational preferences necessary for humanitarian coordination. Profile information includes organizational affiliation, department, job title, location assignment, and language preferences for proper data presentation and communication routing.

Preference management covers notification settings, dashboard configurations, and data visualization options that improve operational efficiency. The system maintains preference inheritance from organizational defaults while allowing individual customization for user-specific requirements.

### 12.2 Architecture

The user management system implements a modular authentication and authorization architecture with clear separation between identity management, access control, and profile management components.

#### Core components

**Authentication Service** handles user identity verification through multiple authentication methods including password-based login, two-factor authentication, and session management. The service integrates with email verification systems and implements security policies for password management and account protection.

**Authorization Engine** evaluates user permissions through role-based access control (RBAC) combined with geographical and organizational constraints. Permission evaluation considers user roles, team memberships, and resource-specific access controls to determine authorization for specific operations and data access.

**Profile Management** maintains extended user information beyond basic authentication credentials, including organizational context, operational preferences, and system configuration settings. Profile synchronization ensures consistent user experience across system components while maintaining data integrity and audit trails.

**Activity Auditing** captures comprehensive user activity logs for security monitoring and compliance reporting. The audit system tracks authentication events, data access patterns, administrative actions, and permission changes to support operational oversight and security analysis.

### 12.3 Data model

#### UserProfile
Extended user information and operational context beyond Django's base User model.

| Field | Type | Description |
|-------|------|-------------|
| `user` | OneToOneField | Associated Django user account |
| `phone` | CharField | Contact phone number |
| `organization` | CharField | Organizational affiliation |
| `department` | CharField | Department or unit within organization |
| `job_title` | CharField | Professional role designation |
| `location` | ForeignKey | Geographic assignment for data access control |
| `language_preference` | CharField | Interface language (English/Arabic) |
| `timezone` | CharField | User timezone for proper datetime display |
| `role` | CharField | System role (admin, analyst, viewer, manager, field_officer) |
| `is_email_verified` | BooleanField | Email verification status |
| `email_verification_token` | CharField | Token for email verification process |
| `email_verification_sent_at` | DateTimeField | Verification email timestamp |
| `two_factor_enabled` | BooleanField | Two-factor authentication status |
| `two_factor_secret` | CharField | TOTP secret for 2FA |
| `password_changed_at` | DateTimeField | Last password modification |
| `force_password_change` | BooleanField | Require password change on next login |
| `last_login_ip` | GenericIPAddressField | IP address of last login |
| `last_activity` | DateTimeField | Last system activity timestamp |
| `login_count` | PositiveIntegerField | Total login attempts counter |
| `failed_login_attempts` | PositiveIntegerField | Failed login counter for lockout |
| `locked_until` | DateTimeField | Account lockout expiration |
| `created_at` | DateTimeField | Profile creation timestamp |
| `updated_at` | DateTimeField | Last profile modification |

#### Team
Organizational groupings for collaborative access and shared permissions.

| Field | Type | Description |
|-------|------|-------------|
| `name` | CharField | Unique team identifier |
| `description` | TextField | Team purpose and scope description |
| `organization` | CharField | Parent organizational unit |
| `members` | ManyToManyField | Team user membership through TeamMembership |
| `permissions` | ManyToManyField | Shared team permissions |
| `is_active` | BooleanField | Team operational status |
| `created_by` | ForeignKey | Team creator reference |
| `created_at` | DateTimeField | Team creation timestamp |
| `updated_at` | DateTimeField | Last team modification |

#### TeamMembership
Individual user participation within teams with role assignments.

| Field | Type | Description |
|-------|------|-------------|
| `team` | ForeignKey | Associated team |
| `user` | ForeignKey | Team member user account |
| `role` | CharField | Membership role (leader, member, guest) |
| `joined_at` | DateTimeField | Membership start timestamp |

#### UserActivity
Comprehensive audit trail for user actions and system interactions.

| Field | Type | Description |
|-------|------|-------------|
| `user` | ForeignKey | User performing the activity |
| `activity_type` | CharField | Action classification (login, logout, password_change, profile_update, data_access, alert_created, report_generated, admin_action) |
| `description` | TextField | Human-readable activity description |
| `ip_address` | GenericIPAddressField | Source IP address for the activity |
| `user_agent` | TextField | Browser/client identification string |
| `session_key` | CharField | Associated session identifier |
| `content_type` | ForeignKey | Related object type for generic relations |
| `object_id` | PositiveIntegerField | Related object identifier |
| `content_object` | GenericForeignKey | Generic relationship to related objects |
| `metadata` | JSONField | Additional structured context data |
| `timestamp` | DateTimeField | Activity occurrence timestamp |

### 12.4 Implementation

#### User registration and verification
The user registration process implements a secure multi-step workflow that includes identity verification, organizational validation, and role assignment. Registration begins with email and basic profile information collection, followed by email verification to confirm identity and prevent spam registrations.

**Email verification** requires users to confirm their email address through a secure token-based system before gaining system access. The verification process includes automatic token expiration and resend capabilities for operational flexibility.

**Profile initialization** creates extended user profiles with organizational context and default preferences based on role assignments. The system applies organizational defaults while supporting user customization for operational efficiency.

#### Authentication workflows
Authentication supports multiple security models including standard password-based login and two-factor authentication for enhanced security. The system implements adaptive security measures including account lockout, session management, and security monitoring.

**Session management** includes configurable timeout periods, concurrent session limits, and automatic logout for security compliance. Session tracking supports operational requirements while maintaining security boundaries for sensitive humanitarian data.

**Password management** enforces complexity policies, expiration schedules, and security monitoring to prevent unauthorized access. Administrative override capabilities ensure operational continuity while maintaining audit trails for security analysis.

#### Authorization Service

```python
class AuthorizationService:
    @staticmethod
    def check_permission(
        user: User,
        permission: str,
        obj: Model = None
    ) -> bool:
        """Check if user has specific permission."""

    @staticmethod
    def get_user_permissions(user: User) -> set:
        """Get all permissions for user."""

    @staticmethod
    def assign_role(
        user: User,
        role: str
    ) -> bool:
        """Assign role to user."""

    @staticmethod
    def get_accessible_objects(
        user: User,
        model_class: Type[Model]
    ) -> QuerySet:
        """Get objects accessible to user."""
```

#### Profile Management

```python
class ProfileManager:
    @staticmethod
    def update_profile(
        user: User,
        **kwargs
    ) -> UserProfile:
        """Update user profile information."""

    @staticmethod
    def update_preferences(
        user: User,
        preferences: dict
    ) -> bool:
        """Update user preferences."""

    @staticmethod
    def enable_two_factor(user: User) -> str:
        """Enable 2FA and return QR code."""

    @staticmethod
    def verify_two_factor(
        user: User,
        token: str
    ) -> bool:
        """Verify 2FA token."""
```

### 12.5 API Endpoints

#### Authentication Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/auth/register/` | Register new user |
| POST | `/api/auth/login/` | User login |
| POST | `/api/auth/logout/` | User logout |
| POST | `/api/auth/refresh-token/` | Refresh JWT token |
| POST | `/api/auth/verify-email/` | Verify email address |
| POST | `/api/auth/reset-password/` | Request password reset |
| POST | `/api/auth/confirm-reset/` | Confirm password reset |
| POST | `/api/auth/change-password/` | Change password |

#### User Management Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/users/` | List users (admin) |
| GET | `/api/users/{id}/` | Get user details |
| PUT | `/api/users/{id}/` | Update user |
| DELETE | `/api/users/{id}/` | Delete user (admin) |
| GET | `/api/users/me/` | Current user profile |
| PUT | `/api/users/me/profile/` | Update profile |
| GET | `/api/users/me/permissions/` | Get permissions |
| GET | `/api/users/me/activity/` | Get activity log |
| POST | `/api/users/me/2fa/enable/` | Enable 2FA |
| POST | `/api/users/me/2fa/disable/` | Disable 2FA |
| POST | `/api/users/me/2fa/verify/` | Verify 2FA token |

#### Team Management Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/teams/` | List teams |
| POST | `/api/teams/` | Create team |
| GET | `/api/teams/{id}/` | Get team details |
| PUT | `/api/teams/{id}/` | Update team |
| DELETE | `/api/teams/{id}/` | Delete team |
| GET | `/api/teams/{id}/members/` | List team members |
| POST | `/api/teams/{id}/members/` | Add team member |
| DELETE | `/api/teams/{id}/members/{user_id}/` | Remove member |

#### Request/Response Examples

**User Registration**
```http
POST /api/auth/register/
Content-Type: application/json

{
    "email": "john.doe@nrc.org",
    "password": "SecureP@ss123",
    "first_name": "John",
    "last_name": "Doe",
    "organization": "NRC",
    "department": "Emergency Response",
    "job_title": "Data Analyst",
    "language_preference": "en"
}

Response:
{
    "user": {
        "id": 123,
        "email": "john.doe@nrc.org",
        "first_name": "John",
        "last_name": "Doe"
    },
    "profile": {
        "organization": "NRC",
        "role": "viewer",
        "is_email_verified": false
    },
    "message": "Registration successful. Please verify your email."
}
```

**Login with 2FA**
```http
POST /api/auth/login/
Content-Type: application/json

{
    "email": "john.doe@nrc.org",
    "password": "SecureP@ss123",
    "two_factor_token": "123456"
}

Response:
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "user": {
        "id": 123,
        "email": "john.doe@nrc.org",
        "role": "analyst"
    }
}
```

### 12.6 Web Interface

#### User Management Dashboard
Administrative interface for managing users and teams.

**Features:**
1. **User List & Search**
   - Filterable user table
   - Quick actions (activate/deactivate, reset password)
   - Bulk operations
   - Export to CSV

2. **User Details Page**
   - Profile information
   - Permission management
   - Activity history
   - Session management
   - Account actions

3. **Team Management**
   - Team creation and editing
   - Member management
   - Permission assignment
   - Team analytics

4. **Profile Settings**
   - Personal information
   - Security settings
   - Notification preferences
   - API tokens

#### Registration & Login Forms

**Registration Flow:**
1. Email and password input
2. Organization details
3. Email verification
4. Profile completion

**Login Flow:**
1. Email/username and password
2. 2FA verification (if enabled)
3. Remember device option
4. Redirect to dashboard

### 12.7 Security Features

#### Password Policy
```python
PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
        'OPTIONS': {'min_length': 12}
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'custom.validators.ComplexityValidator',
        'OPTIONS': {
            'require_uppercase': True,
            'require_lowercase': True,
            'require_digits': True,
            'require_special': True
        }
    }
]
```

#### Session Security
- Session timeout after 30 minutes of inactivity
- Concurrent session limiting
- Session invalidation on password change
- IP-based session validation

#### Account Security
- Account lockout after 5 failed attempts
- CAPTCHA after 3 failed attempts
- Email verification required
- Password expiry after 90 days

### 12.8 Role-Based Access Control (RBAC)

#### Default Roles

| Role | Description | Permissions |
|------|-------------|-------------|
| **Administrator** | Full system access | All permissions |
| **Alert Manager** | Manage alerts and notifications | Create, edit, delete alerts; manage subscriptions |
| **Data Analyst** | Access and analyze data | View all data, create reports, run analyses |
| **Field Officer** | Field data entry and reports | Create data entries, view own region |
| **Viewer** | Read-only access | View public data and reports |

#### Permission Groups
```python
PERMISSION_GROUPS = {
    'alerts': [
        'view_alert',
        'add_alert',
        'change_alert',
        'delete_alert',
        'publish_alert',
    ],
    'data': [
        'view_data',
        'add_data',
        'change_data',
        'delete_data',
        'export_data',
    ],
    'reports': [
        'view_report',
        'create_report',
        'export_report',
        'schedule_report',
    ],
    'admin': [
        'view_user',
        'add_user',
        'change_user',
        'delete_user',
        'view_logs',
        'system_settings',
    ]
}
```

### 12.9 Integration with Other Systems

#### Alert System Integration
- Automatic subscription based on role
- Permission-based alert visibility
- User-specific alert preferences

#### Notification System Integration
- Profile-based notification routing
- Preference management
- Email verification notifications

#### Data Pipeline Integration
- User-specific data access
- Source permissions
- Export authorization

### 12.10 Monitoring and Analytics

#### User Metrics
- Active users (daily, weekly, monthly)
- Login frequency and patterns
- Feature usage statistics
- Role distribution

#### Security Metrics
- Failed login attempts
- Password reset requests
- 2FA adoption rate
- Session analytics

#### Audit Reports
- User activity timeline
- Permission changes
- Data access logs
- Admin actions

### 12.11 Testing

#### Unit Tests
```python
class UserManagementTestCase(TestCase):
    def test_user_registration(self):
        """Test user registration process."""

    def test_email_verification(self):
        """Test email verification flow."""

    def test_password_reset(self):
        """Test password reset process."""

    def test_two_factor_auth(self):
        """Test 2FA enrollment and verification."""

    def test_role_permissions(self):
        """Test role-based access control."""
```

#### Integration Tests
- Registration to login flow
- Team creation and management
- Permission inheritance
- Session management
- Activity logging

### 12.12 Migration and Data Management

#### User Import
Support for bulk user import from CSV/Excel with:
- Validation and error reporting
- Duplicate detection
- Role assignment
- Welcome email sending

#### Data Export
- User list export (CSV, Excel)
- Activity logs export
- Permission matrix export
- Compliance reports (GDPR)

### 12.13 Compliance and Privacy

#### GDPR Compliance
- Right to access (data export)
- Right to deletion (account removal)
- Data portability
- Consent management

#### Privacy Features
- Anonymous usage tracking
- PII encryption
- Data retention policies
- Access logging
