{% extends "base.html" %}
{% load vite_tags %}
{% load static %}
{% load i18n %}
{% load translation_tags %}

{% block title %}{% translate "API Documentation" %} - NRC EWAS{% endblock %}
{% block description %}{% translate "Norwegian Refugee Council EWAS Sudan - API Documentation" %}{% endblock %}
{% block header_subtitle %}{% translate "API Documentation" %}{% endblock %}

{% block content %}

<div class="container-fluid py-4 app-api">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2">
            <div class="sidebar p-3">
                <h6 class="sidebar-heading nrc-heading mb-3">
                    <i class="bi bi-code-slash me-2 text-info"></i>
                    {% translate "API Documentation" %}
                </h6>
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item mb-1">
                        <a class="nav-link active" href="#overview">
                            <i class="bi bi-info-circle me-2"></i>
                            {% translate "Overview" %}
                        </a>
                    </li>
                    {% for module_name, module_data in api_endpoints.items %}
                    <li class="nav-item mb-1">
                        <a class="nav-link" href="#{{ module_name|slugify }}">
                            <i class="bi bi-{{ module_name|lower|first }}{% if 'data' in module_name|lower %}database{% elif 'location' in module_name|lower %}geo-alt{% elif 'task' in module_name|lower %}activity{% else %}gear{% endif %} me-2"></i>
                            {{ module_name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>

                <hr class="my-3">

                <h6 class="sidebar-heading nrc-heading mb-3">
                    <i class="bi bi-lightning me-2 text-warning"></i>
                    {% translate "Quick Links" %}
                </h6>
                <div class="d-grid gap-2">
                    <a href="/alerts/" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-bell me-1"></i>Alerts
                    </a>
                    <a href="/pipeline/" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-diagram-3 me-1"></i>Data Pipeline
                    </a>
                    <a href="/location/" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-geo-alt me-1"></i>Locations
                    </a>
                    <a href="/tasks/" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-activity me-1"></i>Tasks
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/">
                                    <i class="bi bi-house"></i> Home
                                </a>
                            </li>
                            <li class="breadcrumb-item active">API Documentation</li>
                        </ol>
                    </nav>
                    <h1 class="nrc-heading mb-0">
                        <i class="bi bi-code-slash me-2 text-info"></i>API Documentation
                    </h1>
                </div>
            </div>

            <!-- Overview Section -->
            <section id="overview" class="mb-5">
                <div class="card">
                    <div class="card-header">
                        <h2 class="nrc-heading mb-0">
                            <i class="bi bi-info-circle me-2"></i>{% translate "Overview" %}
                        </h2>
                    </div>
                    <div class="card-body">
                        <p class="lead">The NRC Early Warning and Alert System (EWAS) provides a comprehensive REST API for managing humanitarian data, locations, and task monitoring in Sudan.</p>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h5 class="nrc-heading">{% translate "Base URL" %}</h5>
                                <code>{{ request.scheme }}://{{ request.get_host }}</code>

                                <h5 class="nrc-heading mt-3">{% translate "Authentication" %}</h5>
                                <p class="small text-muted">Currently, the API endpoints are accessible without authentication for development purposes. Production deployment will include proper authentication mechanisms.</p>
                            </div>
                            <div class="col-md-6">
                                <h5 class="nrc-heading">{% translate "Response Format" %}</h5>
                                <p class="small text-muted">All API responses are in JSON format with consistent structure:</p>
                                <pre class="bg-light p-2 rounded"><code>{
  "success": true,
  "data": [...],
  "count": 42,
  "message": "optional"
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- API Modules -->
            {% for module_name, module_data in api_endpoints.items %}
            <section id="{{ module_name|slugify }}" class="mb-5">
                <div class="card">
                    <div class="card-header">
                        <h2 class="nrc-heading mb-0">
                            <i class="bi bi-{% if 'data' in module_name|lower %}database{% elif 'location' in module_name|lower %}geo-alt{% elif 'task' in module_name|lower %}activity{% else %}gear{% endif %} me-2"></i>{{ module_name }}
                        </h2>
                        <small class="text-muted">{% translate "Base URL" %}: <code>{{ module_data.base_url }}</code></small>
                    </div>
                    <div class="card-body">
                        {% for endpoint in module_data.endpoints %}
                        <div class="border rounded p-3 mb-3 {% if endpoint.status == 'planned' %}bg-light{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="nrc-heading mb-1">
                                        <span class="badge bg-{% if endpoint.method == 'GET' %}success{% elif endpoint.method == 'POST' %}primary{% elif endpoint.method == 'PUT' %}warning{% elif endpoint.method == 'DELETE' %}danger{% else %}secondary{% endif %} me-2">{{ endpoint.method }}</span>
                                        <code>{{ endpoint.path }}</code>
                                        {% if endpoint.status == 'planned' %}
                                            <span class="badge bg-secondary ms-2">Coming Soon</span>
                                        {% endif %}
                                    </h5>
                                    <p class="text-muted mb-0">{{ endpoint.description }}</p>
                                </div>
                                {% if endpoint.status != 'planned' and endpoint.path|slice:":4" != "/api" %}
                                <a href="{{ endpoint.path }}" class="btn btn-sm btn-outline-info" target="_blank">
                                    <i class="bi bi-box-arrow-up-right me-1"></i>Try It
                                </a>
                                {% endif %}
                            </div>

                            {% if endpoint.parameters %}
                            <div class="mt-3">
                                <h6 class="nrc-heading mb-2">Parameters</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for param in endpoint.parameters %}
                                            <tr>
                                                <td><code>{{ param.name }}</code></td>
                                                <td><span class="badge bg-secondary">{{ param.type }}</span></td>
                                                <td>{{ param.description }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}

                            <div class="mt-3">
                                <h6 class="nrc-heading mb-2">Response</h6>
                                <p class="small text-muted">{{ endpoint.response }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Smooth scrolling for sidebar navigation
document.querySelectorAll('.nav-link[href^="#"]').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });

            // Update active state
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
        }
    });
});

// Update active navigation on scroll
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('section[id]');
    let current = '';

    sections.forEach(section => {
        const sectionTop = section.offsetTop - 100;
        if (window.pageYOffset >= sectionTop) {
            current = section.getAttribute('id');
        }
    });

    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === '#' + current) {
            link.classList.add('active');
        }
    });
});
</script>
{% endblock %}
