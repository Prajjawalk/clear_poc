{% load static %}
{% load i18n %}
{% load translation_tags %}

<!-- NRC Header -->
<header class="nrc-header">
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- Brand and Mobile Menu Toggle -->
            <div class="d-flex align-items-center justify-content-between w-100">
                <a href="/" class="navbar-brand d-flex align-items-center">
                    {% get_current_language as LANGUAGE_CODE %}
                    {% if LANGUAGE_CODE == 'ar' %}
                        <!-- RTL: Text first, then logo -->
                        <span class="nrc-brand-text fs-6 text-nowrap me-3">
                            {% translate "Early Warning and Alert System" %}
                        </span>
                        <!-- Mobile: Square logo without text -->
                        <img src="{% static 'NRC_logo_square_no_text.png' %}" alt="NRC Logo" class="nrc-logo-mobile d-block d-lg-none">
                        <!-- Desktop: Full logo with text -->
                        <img src="{% static 'NRC_logo_English_RGB_negative_aligned_right.png' %}" alt="NRC Logo" class="nrc-logo-desktop d-none d-lg-block">
                    {% else %}
                        <!-- LTR: Logo first, then text -->
                        <!-- Mobile: Square logo without text -->
                        <img src="{% static 'NRC_logo_square_no_text.png' %}" alt="NRC Logo" class="nrc-logo-mobile d-block d-lg-none me-2">
                        <!-- Desktop: Full logo with text -->
                        <img src="{% static 'NRC_logo_English_RGB_negative_aligned_left.png' %}" alt="NRC Logo" class="nrc-logo-desktop d-none d-lg-block me-3">
                        <span class="nrc-brand-text fs-6 text-nowrap">
                            {% translate "Early Warning and Alert System" %}
                        </span>
                    {% endif %}
                </a>

                <!-- Mobile toggle button -->
                <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>

            <!-- Collapsible content -->
            <div class="collapse navbar-collapse" id="navbarMain">
                <!-- Main navigation -->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if request.resolver_match.app_name in 'alerts,data_pipeline,location,task_monitoring' %}active{% endif %}"
                           href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-grid-3x3-gap me-1"></i>
                            {% trans "Apps" %}
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.app_name == 'dashboard' %}active{% endif %}"
                                   href="{% url 'dashboard:dashboard' %}">
                                    <i class="bi bi-speedometer2 me-2"></i>
                                    {% trans "Dashboard" %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.app_name == 'alerts' %}active{% endif %}"
                                   href="{% url 'alerts:alert_list' %}">
                                    <i class="bi bi-bell me-2"></i>
                                    {% trans "Alerts" %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.app_name == 'data_pipeline' %}active{% endif %}"
                                   href="{% url 'data_pipeline:dashboard' %}">
                                    <i class="bi bi-diagram-3 me-2"></i>
                                    {% trans "Data Pipeline" %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.app_name == 'location' %}active{% endif %}"
                                   href="{% url 'location:dashboard' %}">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    {% trans "Locations" %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.app_name == 'task_monitoring' %}active{% endif %}"
                                   href="{% url 'task_monitoring:dashboard' %}">
                                    <i class="bi bi-activity me-2"></i>
                                    {% trans "Tasks" %}
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>

                <!-- Right side items -->
                <div class="d-flex align-items-center gap-3 header-end-items">
                    <span class="badge bg-liste text-dark">Sudan</span>
                    <span class="d-none d-md-inline small text-white text-nowrap">
                        {% block header_subtitle %}{% trans "EWAS Platform" %}{% endblock %}
                    </span>

                    <!-- Language Switcher -->
                    {% language_switcher style="flags" %}

                    {% if user.is_authenticated %}
                    <!-- Notification Bell -->
                    <div class="dropdown">
                        <button class="btn btn-outline-light btn-sm position-relative" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false" id="notificationBell">
                            <i class="bi bi-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                  id="notificationBadge" style="display: none;">
                                <span id="unreadCount">0</span>
                            </span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="width: 320px;" id="notificationDropdown">
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <span>{% trans "Notifications" %}</span>
                                <a href="{% url 'notifications:list' %}" class="text-decoration-none small">
                                    {% trans "View All" %}
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <div id="notificationList">
                                <li class="dropdown-item-text text-center text-muted py-3">
                                    <i class="bi bi-bell-slash"></i><br>
                                    {% trans "No notifications" %}
                                </li>
                            </div>
                            <li><hr class="dropdown-divider"></li>
                            <li class="text-center p-2">
                                <button class="btn btn-sm btn-outline-primary" id="markAllReadBtn" style="display: none;">
                                    {% trans "Mark All Read" %}
                                </button>
                                <a href="{% url 'notifications:center' %}" class="btn btn-sm btn-primary">
                                    {% trans "Notification Center" %}
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- User dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i>
                            <span class="d-none d-sm-inline">{{ user.get_full_name|default:user.username }}</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">{{ user.get_full_name|default:user.username }}</h6></li>
                            <li><span class="dropdown-item-text small text-muted">{{ user.email|default:"No email" }}</span></li>
                            <li><hr class="dropdown-divider"></li>
                            {% if user.groups.all %}
                                <li><span class="dropdown-item-text small">
                                    <strong>Groups:</strong><br>
                                    {% for group in user.groups.all %}
                                        <span class="badge bg-secondary me-1">{{ group.name }}</span>
                                    {% endfor %}
                                </span></li>
                                <li><hr class="dropdown-divider"></li>
                            {% endif %}
                            <li>
                                <form method="post" action="/auth/logout/" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item text-danger border-0 bg-transparent w-100 text-start">
                                        <i class="bi bi-box-arrow-right me-2"></i>Sign Out
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                    {% else %}
                    <a href="/auth/login/" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-box-arrow-in-right me-1"></i>
                        {% trans "Sign In" %}
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
</header>
